@using Learnix.ViewModels.CourseDetailsVMs
@model CourseDetailsViewModel

@{
    Layout = "~/Views/Shared/_LearnixLayout.cshtml";
}

<div class="container-fluid px-0">
    <!-- Enhanced Course Header -->
    <section class="course-header" style="margin-top: 76px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container">
            <div class="row align-items-center py-5">
                <div class="col-lg-8">
                    <!-- Enhanced Breadcrumb -->
                    <nav aria-label="breadcrumb" class="mb-4">
                        <ol class="breadcrumb breadcrumb-light">
                            <li class="breadcrumb-item">
                                <a href="@Url.Action("Index", "Home")" class="text-white-70 text-decoration-none d-flex align-items-center">
                                    <i class="fas fa-home me-2"></i>Home
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="@Url.Action("Index")" class="text-white-70 text-decoration-none d-flex align-items-center">
                                    <i class="fas fa-book me-2"></i>Courses
                                </a>
                            </li>
                            <li class="breadcrumb-item active text-white d-flex align-items-center" aria-current="page">
                                <i class="fas fa-folder me-2"></i>@Model.Category
                            </li>
                        </ol>
                    </nav>

                    <!-- Course Title & Description -->
                    <div class="mb-4">
                        <h1 class="display-4 fw-bold text-white mb-3 text-shadow">@Model.Title</h1>
                        <p class="lead text-white-80 mb-4 fs-5">@Model.Description</p>
                    </div>

                    <!-- Enhanced Stats Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-xl-10">
                            <div class="row g-3">
                                <!-- Students -->
                                <div class="col-sm-6 col-md-3">
                                    <div class="stat-card bg-white bg-opacity-10 rounded-3 p-3 border border-white border-opacity-25">
                                        <div class="d-flex align-items-center">
                                            <div class="stat-icon me-3">
                                                <i class="fas fa-users text-info fa-lg"></i>
                                            </div>
                                            <div>
                                                <div class="h5 fw-bold text-white mb-0">@Model.TotalStudents</div>
                                                <small class="text-white-70">students</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Duration -->
                                <div class="col-sm-6 col-md-3">
                                    <div class="stat-card bg-white bg-opacity-10 rounded-3 p-3 border border-white border-opacity-25">
                                        <div class="d-flex align-items-center">
                                            <div class="stat-icon me-3">
                                                <i class="fas fa-clock text-success fa-lg"></i>
                                            </div>
                                            <div>
                                                <div class="h5 fw-bold text-white mb-0">@Model.Duration</div>
                                                <small class="text-white-70">duration</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Level -->
                                <div class="col-sm-6 col-md-3">
                                    <div class="stat-card bg-white bg-opacity-10 rounded-3 p-3 border border-white border-opacity-25">
                                        <div class="d-flex align-items-center">
                                            <div class="stat-icon me-3">
                                                <i class="fas fa-signal text-purple fa-lg"></i>
                                            </div>
                                            <div>
                                                <div class="h5 fw-bold text-white mb-0">@Model.Level</div>
                                                <small class="text-white-70">level</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Instructor Card -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="instructor-card bg-white bg-opacity-10 rounded-4 p-4 border border-white border-opacity-25">
                                <div class="d-flex align-items-center">
                                    <div class="instructor-avatar me-3">
                                        <div class="avatar-placeholder rounded-circle bg-primary bg-opacity-25 d-flex align-items-center justify-content-center" 
                                             style="width: 60px; height: 60px;">
                                            <i class="fas fa-user-tie text-white fa-lg"></i>
                                        </div>
                                    </div>
                                    <div class="instructor-info  ms-4">
                                        <h6 class="text-white fw-bold mb-1">Instructor</h6>
                                        <div class="h5 text-white mb-1">@Model.Instructor.Name</div>
                                        <p class="text-white-70 mb-0 small">
                                            <i class="fas fa-graduation-cap me-1"></i>@Model.Instructor.Major
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column for Course Image/Badge -->
                <div class="col-lg-4 text-center text-lg-end mt-4 mt-lg-0">
                    <div class="course-badge-container">
                        @if (Model.IsFree)
                        {
                            <div class="free-badge mb-3">
                                <span class="badge bg-success fs-6 px-4 py-3 rounded-pill shadow">
                                    <i class="fas fa-gift me-2"></i>Free Course
                                </span>
                            </div>
                        }
                        else
                        {
                            <div class="price-badge mb-3">
                                <span class="badge bg-warning text-dark fs-5 px-4 py-3 rounded-pill shadow">
                                    <i class="fas fa-tag me-2"></i>$@Model.Price
                                </span>
                            </div>
                        }
                        
                        <!-- Course Image -->
                        <div class="course-header-image mt-4">
                            <img src="/@(Model.ImageUrl ?? "https://images.unsplash.com/photo-1516321318423-f06f85e504b3?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80")" 
                                 alt="@Model.Title" 
                                 class="img-fluid rounded-4 shadow-lg"
                                 style="max-height: 200px; object-fit: cover;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Course Content -->
    <section class="py-5 bg-light">
        <div class="container">
            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8">
                    <!-- Course Overview -->
                    <div class="course-section mb-5">
                        <div class="section-header mb-4">
                            <h3 class="fw-bold mb-2 text-dark">
                                <i class="fas fa-bullseye text-primary me-2"></i>What you'll learn
                            </h3>
                            <div class="section-divider bg-primary" style="height: 3px; width: 60px;"></div>
                        </div>
                        <div class="learning-card bg-white rounded-4 shadow-sm p-4 border">
                            <div class="row g-3">
                                @if (!string.IsNullOrEmpty(Model.LearningOutCome))
                                {
                                    var outcomes = Model.LearningOutCome.Split('\n').Where(o => !string.IsNullOrWhiteSpace(o));
                                    foreach (var outcome in outcomes)
                                    {
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-check-circle text-success mt-1 me-3 flex-shrink-0"></i>
                                                <span class="text-dark">@outcome.Trim()</span>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Course Description -->
                    <div class="course-section mb-5">
                        <div class="section-header mb-4">
                            <h3 class="fw-bold mb-2 text-dark">
                                <i class="fas fa-info-circle text-primary me-2"></i>About this course
                            </h3>
                            <div class="section-divider bg-primary" style="height: 3px; width: 60px;"></div>
                        </div>
                        <div class="description-card bg-white rounded-4 shadow-sm p-4 border">
                            <div class="course-description">
                                <p class="text-dark fs-5 mb-4">@Model.Description</p>
                                
                                @if (!string.IsNullOrEmpty(Model.Requirement))
                                {
                                    <div class="requirements mt-4">
                                        <h6 class="fw-bold text-dark mb-3">
                                            <i class="fas fa-tools text-warning me-2"></i>Requirements
                                        </h6>
                                        <div class="bg-light rounded-3 p-3">
                                            <p class="text-muted mb-0">@Model.Requirement</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Course Curriculum -->
                    <div class="course-section mb-5">
                        <div class="section-header mb-4">
                            <h3 class="fw-bold mb-2 text-dark">
                                <i class="fas fa-book-open text-primary me-2"></i>Course curriculum
                            </h3>
                            <div class="section-divider bg-primary" style="height: 3px; width: 60px;"></div>
                        </div>
                        <div class="curriculum-card bg-white rounded-4 shadow-sm border">
                            <div class="curriculum-stats p-4 border-bottom">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="stat-item">
                                            <h4 class="fw-bold text-primary mb-1">@Model.Sections.Count</h4>
                                            <small class="text-muted">Sections</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-item">
                                            <h4 class="fw-bold text-primary mb-1">@Model.TotalLessons</h4>
                                            <small class="text-muted">Lessons</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-item">
                                            <h4 class="fw-bold text-primary mb-1">@Model.Duration</h4>
                                            <small class="text-muted">Total Duration</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion" id="curriculumAccordion">
                                @{
                                    int sectionIndex = 0;
                                }
                                @foreach (var section in Model.Sections)
                                {
                                    <div class="accordion-item border-0">
                                        <h2 class="accordion-header" id="heading@(section.Id)">
                                            <button class="accordion-button @(sectionIndex == 1 ? "" : "collapsed") bg-light py-4" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse@(section.Id)" 
                                                    aria-expanded="@(sectionIndex == 1 ? "true" : "false")" 
                                                    aria-controls="collapse@(section.Id)">
                                                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-folder-open text-primary me-3 fa-lg"></i>
                                                        <div class="text-start">
                                                            <h6 class="fw-bold text-dark mb-1">@(section.Name)</h6>
                                                            <small class="text-muted">
                                                                @(section.Lessons.Count) lessons • @GetTotalSectionDuration(section.Lessons)
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <i class="fas fa-chevron-down text-primary transition-rotate @(sectionIndex == 0 ? "rotate-180" : "")"></i>
                                                </div>
                                            </button>
                                        </h2>
                                        <div id="collapse@(section.Id)" 
                                             class="accordion-collapse collapse @(sectionIndex == 1 ? "show" : "")" 
                                             aria-labelledby="heading@(section.Id)" 
                                             data-bs-parent="#curriculumAccordion">
                                            <div class="accordion-body px-4 py-3">
                                                <div class="lessons-list">
                                                    @foreach (var lesson in section.Lessons.OrderBy(l => l.Order))
                                                    {
                                                        <div class="lesson-item d-flex justify-content-between align-items-center py-3 border-bottom">
                                                            <div class="d-flex align-items-center flex-grow-1">
                                                                <div class="lesson-icon me-3">
                                                                    <i class="fas fa-play-circle text-primary fa-lg"></i>
                                                                </div>
                                                                <div class="lesson-info flex-grow-1">
                                                                    <h6 class="fw-semibold text-dark mb-1">@lesson.Title</h6>
                                                                    @if (!string.IsNullOrEmpty(lesson.Description))
                                                                    {
                                                                        <p class="text-muted small mb-0">@lesson.Description</p>
                                                                    }
                                                                </div>
                                                            </div>
                                                            <div class="lesson-meta text-end">
                                                                <span class="badge bg-light text-dark border">@lesson.Duration</span>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    sectionIndex++;
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Instructor -->
                    <div class="course-section mb-5">
                        <div class="section-header mb-4">
                            <h3 class="fw-bold mb-2 text-dark">
                                <i class="fas fa-chalkboard-teacher text-primary me-2"></i>Your instructor
                            </h3>
                            <div class="section-divider bg-primary" style="height: 3px; width: 60px;"></div>
                        </div>
                        <div class="instructor-card bg-white rounded-4 shadow-sm p-4 border">
                            <div class="row align-items-center">
                                <div class="col-md-3 text-center mb-3 mb-md-0">
                                    <div class="instructor-avatar mx-auto">
                                        <div class="avatar-placeholder bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 100px; height: 100px;">
                                            <i class="fas fa-user-tie text-primary fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <h4 class="fw-bold text-dark mb-2">@Model.Instructor.Name</h4>
                                    <p class="text-primary mb-3">
                                        <i class="fas fa-graduation-cap me-2"></i>@Model.Instructor.Major
                                    </p>
                                    
                                    <div class="instructor-stats bg-light rounded-3 p-3">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="stat-item">
                                                    <h5 class="fw-bold text-primary mb-1">@Model.Instructor.TotalStudents</h5>
                                                    <small class="text-muted">Students</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="stat-item">
                                                    <h5 class="fw-bold text-primary mb-1">@Model.Instructor.TotalCourses</h5>
                                                    <small class="text-muted">Courses</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <div class="course-sidebar sticky-top" style="top: 100px;">
                        <!-- Pricing Card -->
                        <div class="pricing-card mb-4">
                            <div class="card border-0 shadow-lg rounded-4">
                                <div class="card-header bg-primary text-white rounded-top-4 py-4">
                                    <div class="text-center">
                                        @if (Model.IsFree)
                                        {
                                            <h3 class="fw-bold mb-0">Free</h3>
                                            <p class="mb-0 opacity-75">Lifetime Access</p>
                                        }
                                        else
                                        {
                                            <h3 class="fw-bold mb-0">$@Model.Price</h3>
                                            <p class="mb-0 opacity-75">One-time payment</p>
                                        }
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    <div class="d-grid gap-2 mb-4">
                                        <a class="btn btn-primary btn-lg py-3 fw-bold rounded-3" href="/Student/Course/Enroll/@Model.Id">
                                            <i class="fas fa-shopping-cart me-2"></i>Enroll Now
                                        </a>
                                    </div>
                                    
                                    <div class="course-includes">
                                        <h6 class="fw-bold text-dark mb-3">
                                            <i class="fas fa-gift text-primary me-2"></i>This course includes:
                                        </h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-3 d-flex align-items-center">
                                                <i class="fas fa-play-circle text-primary me-3 fa-lg"></i>
                                                <span class="text-dark">@Model.Duration on-demand video</span>
                                            </li>
                                            <li class="mb-3 d-flex align-items-center">
                                                <i class="fas fa-mobile-alt text-primary me-3 fa-lg"></i>
                                                <span class="text-dark">Access on mobile and desktop</span>
                                            </li>
                                            <li class="mb-3 d-flex align-items-center">
                                                <i class="fas fa-infinity text-primary me-3 fa-lg"></i>
                                                <span class="text-dark">Full lifetime access</span>
                                            </li>
                                            <li class="mb-3 d-flex align-items-center">
                                                <i class="fas fa-certificate text-primary me-3 fa-lg"></i>
                                                <span class="text-dark">Certificate of completion</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Facts Card -->
                        <div class="facts-card card border-0 shadow-sm rounded-4 mb-4">
                            <div class="card-body p-4">
                                <h6 class="fw-bold text-dark mb-3">
                                    <i class="fas fa-chart-bar text-primary me-2"></i>Course Details
                                </h6>
                                <div class="facts-list">
                                    <div class="fact-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <span class="text-muted">Level</span>
                                        <span class="fw-semibold text-dark">@Model.Level</span>
                                    </div>
                                    <div class="fact-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <span class="text-muted">Duration</span>
                                        <span class="fw-semibold text-dark">@Model.Duration</span>
                                    </div>
                                    <div class="fact-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <span class="text-muted">Students</span>
                                        <span class="fw-semibold text-dark">@Model.TotalStudents</span>
                                    </div>
                                    <div class="fact-item d-flex justify-content-between align-items-center py-2">
                                        <span class="text-muted">Last Updated</span>
                                        <span class="fw-semibold text-dark">Recently</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
    .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .text-white-70 {
        color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .text-white-80 {
        color: rgba(255, 255, 255, 0.8) !important;
    }
    
    .bg-purple {
        background-color: #6f42c1 !important;
    }
    
    .text-purple {
        color: #6f42c1 !important;
    }
    
    .breadcrumb-light .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.5);
    }
    
    .stat-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .instructor-card {
        transition: transform 0.2s ease;
    }
    
    .instructor-card:hover {
        transform: translateX(5px);
    }
    
    .avatar-placeholder {
        backdrop-filter: blur(10px);
    }
    
    .course-header-image {
        transition: transform 0.3s ease;
    }
    
    .course-header-image:hover {
        transform: scale(1.05);
    }
    
    .section-header {
        position: relative;
    }

    .section-divider {
        border-radius: 2px;
    }

    .transition-rotate {
        transition: transform 0.3s ease;
    }

    .rotate-180 {
        transform: rotate(180deg);
    }

    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa !important;
        color: #000 !important;
        box-shadow: none;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }

    .lesson-item {
        transition: background-color 0.2s ease;
    }

    .lesson-item:hover {
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-left: -8px;
        margin-right: -8px;
        padding-left: 8px !important;
        padding-right: 8px !important;
    }

    .sticky-top {
        position: sticky;
        z-index: 10;
    }

    .pricing-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }

    .btn-outline-primary {
        color: #667eea;
        border-color: #667eea;
    }

    .btn-outline-primary:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .display-4 {
            font-size: 2rem;
        }
        
        .stat-card {
            text-align: center;
        }
        
        .instructor-card {
            text-align: center;
        }
        
        .course-header-image {
            max-height: 150px !important;
        }
    }
</style>

@section Scripts {
    <script>
        // Initialize accordion functionality
        document.addEventListener('DOMContentLoaded', function() {
            const accordionButtons = document.querySelectorAll('.accordion-button');
            
            accordionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const icon = this.querySelector('.fa-chevron-down');
                    if (icon) {
                        icon.classList.toggle('rotate-180');
                    }
                });
            });

            // Handle accordion show event to update icons
            const accordionCollapses = document.querySelectorAll('.accordion-collapse');
            accordionCollapses.forEach(collapse => {
                collapse.addEventListener('show.bs.collapse', function() {
                    const button = document.querySelector('[data-bs-target="#' + this.id + '"]');
                    const icon = button?.querySelector('.fa-chevron-down');
                    if (icon) {
                        icon.classList.add('rotate-180');
                    }
                });

                collapse.addEventListener('hide.bs.collapse', function() {
                    const button = document.querySelector('[data-bs-target="#' + this.id + '"]');
                    const icon = button?.querySelector('.fa-chevron-down');
                    if (icon) {
                        icon.classList.remove('rotate-180');
                    }
                });
            });
        });
    </script>
}

@functions {
    public string GetTotalSectionDuration(List<LessonViewModel> lessons)
    {
        if (lessons == null || !lessons.Any())
            return "0 min";

        int totalMinutes = lessons.Sum(lesson =>
        {
            if (string.IsNullOrEmpty(lesson.Duration)) return 0;
            
            var match = System.Text.RegularExpressions.Regex.Match(lesson.Duration, @"\d+");
            return match.Success ? int.Parse(match.Value) : 0;
        });

        if (totalMinutes >= 60)
        {
            int hours = totalMinutes / 60;
            int minutes = totalMinutes % 60;
            return minutes > 0 ? $"{hours}h {minutes}m" : $"{hours}h";
        }

        return $"{totalMinutes}m";
    }
}